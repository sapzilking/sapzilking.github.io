---
title:  "CGLIB" 
excerpt: "CGLIBì— ëŒ€í•´ ì•Œì•„ë³´ì."

categories:
  - Java
tags:
  - [CGLIB]

toc: true
toc_sticky: true

date: 2022-04-26
last_modified_at: 2022-04-26
---

ì¸í”„ëŸ°ì— ìˆëŠ” ê¹€ì˜í•œ ë‹˜ì˜ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ ë‚´ìš© ì…ë‹ˆë‹¤. ğŸ˜€    
[ğŸŒœ [ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ - ê³ ê¸‰í¸]ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸°!](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%95%B5%EC%8B%AC-%EC%9B%90%EB%A6%AC-%EA%B3%A0%EA%B8%89%ED%8E%B8/dashboard){:target="_blank"}
{: .notice--warning}

ì§€ë‚œë²ˆì— ì•Œì•„ ë³¸ [JDKë™ì  í”„ë¡ì‹œ](https://sapzilking.github.io/java/JdkDynamicProxy/) ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ í•„ìˆ˜ì˜€ë‹¤.  
ì¸í„°í˜ì´ìŠ¤ ì—†ì´ í´ë˜ìŠ¤ë§Œ ìˆëŠ” ê²½ìš°ì— ë™ì  í”„ë¡ì‹œë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì.  
ì´ê²ƒì€ ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œëŠ” ì–´ë µê³  CGLIB ë¼ëŠ” ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•˜ëŠ” íŠ¹ë³„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## ğŸ”” CGLIB - ì†Œê°œ

**CGLIB: Code Generator Library**  
* CGLIBëŠ” ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•´ì„œ ë™ì ìœ¼ë¡œ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ê¸°ìˆ ì„ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
* CGLIBë¥¼ ì‚¬ìš©í•˜ë©´ ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ì–´ë„ êµ¬ì²´ í´ë˜ìŠ¤ë§Œ ê°€ì§€ê³  ë™ì  í”„ë¡ì‹œë¥¼ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆë‹¤.
* CGLIBëŠ” ì›ë˜ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ë°, ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ê°€ ìŠ¤í”„ë§ ë‚´ë¶€ ì†ŒìŠ¤ ì½”ë“œì— í¬í•¨í–ˆë‹¤. ë”°ë¼ì„œ ìŠ¤í”„ë§ì„ ì‚¬ìš©í•œë‹¤ë©´ ë³„ë„ì˜ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ì°¸ê³ ë¡œ ìš°ë¦¬ê°€ CGLIBë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ê±°ì˜ ì—†ë‹¤. ì´í›„ì— ì„¤ëª…í•  ìŠ¤í”„ë§ì˜ `ProxyFactory` ë¼ëŠ” ê²ƒì´ ì´ ê¸°ìˆ ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì£¼ê¸° ë•Œë¬¸ì—, ë„ˆë¬´ ê¹Šì´ìˆê²Œ íŒŒê¸° ë³´ë‹¤ëŠ” CGLIBê°€ ë¬´ì—‡ì¸ì§€ ëŒ€ëµ ê°œë…ë§Œ ì¡ìœ¼ë©´ ëœë‹¤.  
ì˜ˆì œ ì½”ë“œë¡œ CGLIBë¥¼ ê°„ë‹¨íˆ ì´í•´í•´ë³´ì.

## ğŸ”” ê³µí†µ ì˜ˆì œ ì½”ë“œ
ì•ìœ¼ë¡œ ë‹¤ì–‘í•œ ìƒí™©ì„ ì„¤ëª…í•˜ê¸° ìœ„í•´ì„œ ë¨¼ì € ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  ì˜ˆì œ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë³´ì.
* ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ì´ ìˆëŠ” ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ - `ServiceInterface` , `ServiceImpl`
* êµ¬ì²´ í´ë˜ìŠ¤ë§Œ ìˆëŠ” ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ - `ConcreteService`

**ServiceInterface**
```java
public interface ServiceInterface {
    void save();
    void find();
}
```

**ServiceImpl**
```java
@Slf4j
public class ServiceImpl implements ServiceInterface {
    @Override
    public void save() {
        log.info("save í˜¸ì¶œ");
    }
    
    @Override
    public void find() {
        log.info("find í˜¸ì¶œ");
    }
}
```

**ConcreteService**
```java
@Slf4j
public class ConcreteService {
    public void call() {
        log.info("ConcreteService í˜¸ì¶œ");
    }
}
```

### ğŸ”” CGLIB - ì˜ˆì œ ì½”ë“œ
**CGLIB ì½”ë“œ**  
JDK ë™ì  í”„ë¡ì‹œì—ì„œ ì‹¤í–‰ ë¡œì§ì„ ìœ„í•´ `InvocationHandler` ë¥¼ ì œê³µí–ˆë“¯ì´, CGLIBëŠ” `MethodInterceptor` ë¥¼ ì œê³µí•œë‹¤.
**MethodInterceptor -CGLIB ì œê³µ**
```java
package org.springframework.cglib.proxy;
  
public interface MethodInterceptor extends Callback {
    Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable;
}
```
* obj : CGLIBê°€ ì ìš©ëœ ê°ì²´
* method : í˜¸ì¶œëœ ë©”ì„œë“œ
* args : ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ì „ë‹¬ëœ ì¸ìˆ˜
* proxy : ë©”ì„œë“œ í˜¸ì¶œì— ì‚¬ìš©

**TimeMethodInterceptor**
```java
@Slf4j
public class TimeMethodInterceptor implements MethodInterceptor {
    
    private final Object target;
      
    public TimeMethodInterceptor(Object target) {
        this.target = target;
    }

    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        log.info("TimeProxy ì‹¤í–‰");
        long startTime = System.currentTimeMillis();

        Object result = proxy.invoke(target, args);

        long endTime = System.currentTimeMillis();
        long resultTime = endTime - startTime;
        log.info("TimeProxy ì¢…ë£Œ resultTime={}", resultTime);

        return result;
    }
}
```

* `TimeMethodInterceptor` ëŠ” `MethodInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì„œ CGLIB í”„ë¡ì‹œì˜ ì‹¤í–‰ ë¡œì§ì„ ì •ì˜í•œë‹¤.
* JDK ë™ì  í”„ë¡ì‹œë¥¼ ì„¤ëª…í•  ë•Œ ì˜ˆì œì™€ ê±°ì˜ ê°™ì€ ì½”ë“œì´ë‹¤.
* `Object target` : í”„ë¡ì‹œê°€ í˜¸ì¶œí•  ì‹¤ì œ ëŒ€ìƒ
* `proxy.invoke(target, args)` : ì‹¤ì œ ëŒ€ìƒì„ ë™ì ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.
  * ì°¸ê³ ë¡œ `method` ë¥¼ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ, CGLIBëŠ” ì„±ëŠ¥ìƒ `MethodProxy proxy` ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

ì´ì œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ CGLIBë¥¼ ì‚¬ìš©í•´ë³´ì.

### ğŸ”” CGLIB - í…ŒìŠ¤íŠ¸
**CglibTest**
```java
@Slf4j
public class CglibTest {
    
    @Test
    void cglib() {
        ConcreteService target = new ConcreteService();

        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(ConcreteService.class);
        enhancer.setCallback(new TimeMethodInterceptor(target));
        ConcreteService proxy = (ConcreteService)enhancer.create();
        log.info("targetClass={}", target.getClass());
        log.info("proxyClass={}", proxy.getClass());

        proxy.call();
    }
}
```

`ConcreteService` ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ëŠ” êµ¬ì²´ í´ë˜ìŠ¤ì´ë‹¤. ì—¬ê¸°ì— CGLIBë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¥¼ ìƒì„±í•´ë³´ì.

* `Enhancer` : CGLIBëŠ” `Enhancer` ë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¥¼ ìƒì„±í•œë‹¤.
* `enhancer.setSuperclass(ConcreteService.class)` : CGLIBëŠ” êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ í”„ë¡ì‹œë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤. ì–´ë–¤ êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì„ì§€ ì§€ì •í•œë‹¤.
* `enhancer.setCallback(new TimeMethodInterceptor(target))`
  * í”„ë¡ì‹œì— ì ìš©í•  ì‹¤í–‰ ë¡œì§ì„ í• ë‹¹í•œë‹¤.
* enhancer.create() : í”„ë¡ì‹œë¥¼ ìƒì„±í•œë‹¤. ì•ì„œ ì„¤ì •í•œ `enhancer.setSuperclass(ConcreteService.class)` ì—ì„œ ì§€ì •í•œ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ í”„ë¡ì‹œê°€ ë§Œë“¤ì–´ì§„ë‹¤.

JDK ë™ì  í”„ë¡ì‹œëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„(implement)í•´ì„œ í”„ë¡ì‹œë¥¼ ë§Œë“ ë‹¤. CGLIBëŠ” êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ìƒì† (extends)í•´ì„œ í”„ë¡ì‹œë¥¼ ë§Œë“ ë‹¤.

**ì‹¤í–‰ ê²°ê³¼**
```
CglibTest - targetClass=class hello.proxy.common.service.ConcreteService
CglibTest - proxyClass=class hello.proxy.common.service.ConcreteService$ $EnhancerByCGLIB$$25d6b0e3
TimeMethodInterceptor - TimeProxy ì‹¤í–‰
ConcreteService - ConcreteService í˜¸ì¶œ
TimeMethodInterceptor - TimeProxy ì¢…ë£Œ resultTime=9
```
ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³´ë©´ í”„ë¡ì‹œê°€ ì •ìƒ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**CGLIBê°€ ìƒì„±í•œ í”„ë¡ì‹œ í´ë˜ìŠ¤ ì´ë¦„**  
CGLIBë¥¼ í†µí•´ì„œ ìƒì„±ëœ í´ë˜ìŠ¤ì˜ ì´ë¦„ì„ í™•ì¸í•´ë³´ì.  
`ConcreteService$$EnhancerByCGLIB$$25d6b0e3`

CGLIBê°€ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í´ë˜ìŠ¤ ì´ë¦„ì€ ë‹¤ìŒê³¼ ê°™ì€ ê·œì¹™ìœ¼ë¡œ ìƒì„±ëœë‹¤.
`ëŒ€ìƒí´ë˜ìŠ¤$$EnhancerByCGLIB$$ì„ì˜ì½”ë“œ`

ì°¸ê³ ë¡œ ë‹¤ìŒì€ JDK Proxyê°€ ìƒì„±í•œ í´ë˜ìŠ¤ ì´ë¦„ì´ë‹¤.
`proxyClass=class com.sun.proxy.$Proxy1`

<br>

**ê·¸ë¦¼ìœ¼ë¡œ ì •ë¦¬**

![img35](https://user-images.githubusercontent.com/93430103/165299827-33311320-3ebc-4dd0-99c6-8668cf5b00aa.png)

![img36](https://user-images.githubusercontent.com/93430103/165299839-947aaad9-64b8-411b-81cf-2e4e00ec4c2b.png)

## ğŸ”” CGLIB - ì œì•½
**CGLIB ì œì•½**  
* í´ë˜ìŠ¤ ê¸°ë°˜ í”„ë¡ì‹œëŠ” ìƒì†ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ëª‡ê°€ì§€ ì œì•½ì´ ìˆë‹¤.
* ë¶€ëª¨ í´ë˜ìŠ¤ì˜ ìƒì„±ìë¥¼ ì²´í¬í•´ì•¼ í•œë‹¤. -> CGLIBëŠ” ìì‹ í´ë˜ìŠ¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ê¸°ë³¸ ìƒì„±ìê°€ í•„ìš”í•˜ë‹¤.
* í´ë˜ìŠ¤ì— `final` í‚¤ì›Œë“œê°€ ë¶™ìœ¼ë©´ ìƒì†ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. -> CGLIBì—ì„œëŠ” ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
* ë©”ì„œë“œì— `final` í‚¤ì›Œë“œê°€ ë¶™ìœ¼ë©´ í•´ë‹¹ ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”© í•  ìˆ˜ ì—†ë‹¤. -> CGLIBì—ì„œëŠ” í”„ë¡ì‹œ ë¡œì§ì´ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.

## ğŸ”” CGLIB - ì •ë¦¬
**ì •ë¦¬**  
* ì¸í„°í˜ì´ìŠ¤ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” JDK ë™ì  í”„ë¡ì‹œë¥¼ ì ìš©í•˜ê³ , ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” CGLIBë¥¼ ì ìš©í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?  
* ë‘ ê¸°ìˆ ì„ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ë¶€ê°€ ê¸°ëŠ¥ì„ ì œê³µí•˜ê¸° ìœ„í•´ì„œ JDK ë™ì  í”„ë¡ì‹œê°€ ì œê³µí•˜ëŠ” InvocationHandler ì™€ CGLIBê°€ ì œê³µí•˜ëŠ” MethodInterceptor ë¥¼ ê°ê° ì¤‘ë³µìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•´ì•¼ í• ê¹Œ?
* íŠ¹ì • ì¡°ê±´ì— ë§ì„ ë•Œ í”„ë¡ì‹œ ë¡œì§ì„ ì ìš©í•˜ëŠ” ê¸°ëŠ¥ë„ ê³µí†µìœ¼ë¡œ ì œê³µë˜ì—ˆìœ¼ë©´?

<br>

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}
<br>
